@page "/inicio-rapido"
@using EnerfoneCRM.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Inicio Rápido - CorCRM</PageTitle>

@if (AuthService.UsuarioActual?.Rol != "Administrador")
{
    <div class="container mt-5">
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No tienes permisos para acceder a esta sección.
        </div>
    </div>
}
else
{
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-lightning-charge me-2"></i>Inicio Rápido - Importación Masiva</h2>
        </div>

        @if (!string.IsNullOrEmpty(mensajeExito))
        {
            <div class="alert alert-success alert-dismissible fade show">
                <i class="bi bi-check-circle me-2"></i>@mensajeExito
                <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="bi bi-exclamation-triangle me-2"></i>@mensajeError
                <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
            </div>
        }

        <div class="row g-4">
            <!-- Tarjeta de Clientes -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Importar Clientes</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Importa clientes de forma masiva desde un archivo Excel. 
                            Primero descarga la plantilla, complétala con los datos y súbela.
                        </p>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" @onclick="DescargarPlantillaClientes">
                                <i class="bi bi-download me-2"></i>Descargar Plantilla
                            </button>
                            
                            <div class="mt-3">
                                <label class="form-label fw-bold">Seleccionar archivo Excel</label>
                                <InputFile OnChange="@(e => CargarArchivoClientes(e))" class="form-control" accept=".xlsx,.xls" />
                            </div>
                            
                            <button class="btn btn-primary mt-2" @onclick="ImportarClientes" disabled="@(archivoClientes == null || procesando)">
                                @if (procesando && tipoImportacion == "clientes")
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-upload me-2"></i>Importar Clientes
                            </button>
                        </div>

                        @if (resultadoClientes != null)
                        {
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <strong>Resultado:</strong><br/>
                                    ✓ Importados: @resultadoClientes.Importados<br/>
                                    ✗ Errores: @resultadoClientes.Errores
                                </div>
                                
                                @if (resultadoClientes.Errores > 0 && resultadoClientes.DetalleErrores.Any())
                                {
                                    <div class="alert alert-warning">
                                        <strong>Detalles de errores:</strong>
                                        <ul class="mb-0 mt-2">
                                            @foreach (var error in resultadoClientes.DetalleErrores.Take(10))
                                            {
                                                <li><small>@error</small></li>
                                            }
                                            @if (resultadoClientes.DetalleErrores.Count > 10)
                                            {
                                                <li><small><em>... y @(resultadoClientes.DetalleErrores.Count - 10) errores más</em></small></li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Contratos -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Importar Contratos</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Importa contratos de forma masiva desde un archivo Excel.
                            Primero descarga la plantilla según el tipo, complétala y súbela.
                        </p>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tipo de Contrato</label>
                            <select class="form-select" @bind="tipoContratoSeleccionado">
                                <option value="">-- Seleccionar tipo --</option>
                                <option value="energia">Energía</option>
                                <option value="telefonia">Telefonía</option>
                                <option value="alarmas">Alarmas</option>
                            </select>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success" @onclick="DescargarPlantillaContratos" 
                                    disabled="@string.IsNullOrEmpty(tipoContratoSeleccionado)">
                                <i class="bi bi-download me-2"></i>Descargar Plantilla
                            </button>
                            
                            <div class="mt-3">
                                <label class="form-label fw-bold">Seleccionar archivo Excel</label>
                                <InputFile OnChange="@(e => CargarArchivoContratos(e))" class="form-control" accept=".xlsx,.xls" />
                            </div>
                            
                            <button class="btn btn-success mt-2" @onclick="ImportarContratos" 
                                    disabled="@(archivoContratos == null || string.IsNullOrEmpty(tipoContratoSeleccionado) || procesando)">
                                @if (procesando && tipoImportacion == "contratos")
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-upload me-2"></i>Importar Contratos
                            </button>
                        </div>

                        @if (resultadoContratos != null)
                        {
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <strong>Resultado:</strong><br/>
                                    ✓ Importados: @resultadoContratos.Importados<br/>
                                    ✗ Errores: @resultadoContratos.Errores
                                </div>
                                
                                @if (resultadoContratos.Errores > 0 && resultadoContratos.DetalleErrores.Any())
                                {
                                    <div class="alert alert-warning">
                                        <strong>Detalles de errores:</strong>
                                        <ul class="mb-0 mt-2">
                                            @foreach (var error in resultadoContratos.DetalleErrores.Take(10))
                                            {
                                                <li><small>@error</small></li>
                                            }
                                            @if (resultadoContratos.DetalleErrores.Count > 10)
                                            {
                                                <li><small><em>... y @(resultadoContratos.DetalleErrores.Count - 10) errores más</em></small></li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información Importante</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Las plantillas contienen las columnas obligatorias y opcionales para cada tipo de dato.</li>
                    <li>Los campos marcados con asterisco (*) son obligatorios.</li>
                    <li>Para contratos, la columna <strong>IdCliente*</strong> debe contener el <strong>DNI/CIF</strong> del cliente.</li>
                    <li>Asegúrate de que los clientes estén importados antes de importar contratos.</li>
                    <li>El proceso puede tardar varios minutos dependiendo del tamaño del archivo.</li>
                    <li>Se mostrará un resumen con el número de registros importados y errores encontrados.</li>
                </ul>
            </div>
        </div>
    </div>
}

@code {
    private string mensajeExito = string.Empty;
    private string mensajeError = string.Empty;
    private bool procesando = false;
    private string tipoImportacion = string.Empty;
    
    private IBrowserFile? archivoClientes;
    private IBrowserFile? archivoContratos;
    private string tipoContratoSeleccionado = string.Empty;
    
    private ResultadoImportacion? resultadoClientes;
    private ResultadoImportacion? resultadoContratos;
    private bool verificacionRealizada = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !verificacionRealizada)
        {
            verificacionRealizada = true;
            if (AuthService.UsuarioActual == null || AuthService.UsuarioActual.Rol != "Administrador")
            {
                Navigation.NavigateTo("/");
            }
        }
    }

    private async Task DescargarPlantillaClientes()
    {
        try
        {
            await JS.InvokeVoidAsync("descargarPlantillaClientes");
            mensajeExito = "Plantilla de clientes descargada correctamente.";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al descargar plantilla: {ex.Message}";
        }
    }

    private async Task DescargarPlantillaContratos()
    {
        if (string.IsNullOrEmpty(tipoContratoSeleccionado))
        {
            mensajeError = "Selecciona un tipo de contrato primero.";
            return;
        }

        try
        {
            string funcionJS = tipoContratoSeleccionado switch
            {
                "energia" => "descargarPlantillaContratosEnergia",
                "telefonia" => "descargarPlantillaContratosTelefonia",
                "alarmas" => "descargarPlantillaContratosAlarmas",
                _ => ""
            };

            if (!string.IsNullOrEmpty(funcionJS))
            {
                await JS.InvokeVoidAsync(funcionJS);
                mensajeExito = $"Plantilla de contratos de {tipoContratoSeleccionado} descargada correctamente.";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al descargar plantilla: {ex.Message}";
        }
    }

    private void CargarArchivoClientes(InputFileChangeEventArgs e)
    {
        archivoClientes = e.File;
        resultadoClientes = null;
        mensajeExito = string.Empty;
        mensajeError = string.Empty;
    }

    private void CargarArchivoContratos(InputFileChangeEventArgs e)
    {
        archivoContratos = e.File;
        resultadoContratos = null;
        mensajeExito = string.Empty;
        mensajeError = string.Empty;
    }

    private async Task ImportarClientes()
    {
        if (archivoClientes == null) return;

        procesando = true;
        tipoImportacion = "clientes";
        mensajeExito = string.Empty;
        mensajeError = string.Empty;
        resultadoClientes = null;

        try
        {
            // Guardar archivo temporalmente
            var rutaTemporal = Path.Combine(Path.GetTempPath(), archivoClientes.Name);
            
            await using FileStream fs = new(rutaTemporal, FileMode.Create);
            await archivoClientes.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(fs);
            fs.Close();

            // Determinar directorio de trabajo (desarrollo vs producción)
            var directorioActual = Directory.GetCurrentDirectory();
            var scriptPath = Path.Combine(directorioActual, "importar_clientes.py");
            var directorioTrabajo = directorioActual;
            
            // Si el script no está en el directorio actual, buscar en el directorio padre (desarrollo)
            if (!File.Exists(scriptPath))
            {
                directorioTrabajo = Path.Combine(directorioActual, "..");
                scriptPath = Path.Combine(directorioTrabajo, "importar_clientes.py");
            }

            // Verificar que el script existe
            if (!File.Exists(scriptPath))
            {
                throw new Exception($"No se encontró el script importar_clientes.py en {directorioActual} ni en {directorioTrabajo}");
            }

            // Ejecutar script de Python
            var proceso = new System.Diagnostics.Process
            {
                StartInfo = new System.Diagnostics.ProcessStartInfo
                {
                    FileName = @"C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe",
                    Arguments = $"importar_clientes.py \"{rutaTemporal}\"",
                    WorkingDirectory = directorioTrabajo,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                }
            };

            proceso.Start();
            string salida = await proceso.StandardOutput.ReadToEndAsync();
            string errores = await proceso.StandardError.ReadToEndAsync();
            await proceso.WaitForExitAsync();

            // Debug: Mostrar salida completa
            if (!string.IsNullOrWhiteSpace(errores))
            {
                mensajeError = $"ERROR DEL SCRIPT:\n{errores}";
                return;
            }

            if (string.IsNullOrWhiteSpace(salida))
            {
                mensajeError = "El script no devolvió ninguna salida. Verifica permisos y que Python esté correctamente instalado.";
                return;
            }

            // Parsear resultado
            resultadoClientes = ParsearResultado(salida);

            if (resultadoClientes.Importados > 0)
            {
                mensajeExito = $"Importación completada: {resultadoClientes.Importados} clientes importados.";
            }
            else if (resultadoClientes.Errores > 0)
            {
                mensajeError = $"Errores encontrados. Revisa los detalles.";
            }
            else
            {
                // Mostrar salida completa para debug
                mensajeError = $"No se pudo parsear el resultado. SALIDA COMPLETA DEL SCRIPT:\n\n{salida}";
            }

            // Limpiar archivo temporal
            if (File.Exists(rutaTemporal))
                File.Delete(rutaTemporal);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error durante la importación: {ex.Message}";
        }
        finally
        {
            procesando = false;
            tipoImportacion = string.Empty;
        }
    }

    private async Task ImportarContratos()
    {
        if (archivoContratos == null || string.IsNullOrEmpty(tipoContratoSeleccionado)) return;

        procesando = true;
        tipoImportacion = "contratos";
        mensajeExito = string.Empty;
        mensajeError = string.Empty;
        resultadoContratos = null;

        try
        {
            // Guardar archivo temporalmente
            var rutaTemporal = Path.Combine(Path.GetTempPath(), archivoContratos.Name);
            
            await using FileStream fs = new(rutaTemporal, FileMode.Create);
            await archivoContratos.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(fs);
            fs.Close();

            // Determinar directorio de trabajo (desarrollo vs producción)
            var directorioActual = Directory.GetCurrentDirectory();
            var scriptPath = Path.Combine(directorioActual, "importar_contratos.py");
            var directorioTrabajo = directorioActual;
            
            // Si el script no está en el directorio actual, buscar en el directorio padre (desarrollo)
            if (!File.Exists(scriptPath))
            {
                directorioTrabajo = Path.Combine(directorioActual, "..");
                scriptPath = Path.Combine(directorioTrabajo, "importar_contratos.py");
            }

            // Verificar que el script existe
            if (!File.Exists(scriptPath))
            {
                throw new Exception($"No se encontró el script importar_contratos.py en {directorioActual} ni en {directorioTrabajo}");
            }

            // Ejecutar script de Python
            var proceso = new System.Diagnostics.Process
            {
                StartInfo = new System.Diagnostics.ProcessStartInfo
                {
                    FileName = @"C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe",
                    Arguments = $"importar_contratos.py {tipoContratoSeleccionado} \"{rutaTemporal}\"",
                    WorkingDirectory = directorioTrabajo,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                }
            };

            proceso.Start();
            string salida = await proceso.StandardOutput.ReadToEndAsync();
            string errores = await proceso.StandardError.ReadToEndAsync();
            await proceso.WaitForExitAsync();

            // Debug: Mostrar salida completa
            if (!string.IsNullOrWhiteSpace(errores))
            {
                mensajeError = $"ERROR DEL SCRIPT:\n{errores}";
                return;
            }

            if (string.IsNullOrWhiteSpace(salida))
            {
                mensajeError = "El script no devolvió ninguna salida. Verifica permisos y que Python esté correctamente instalado.";
                return;
            }

            // Parsear resultado
            resultadoContratos = ParsearResultado(salida);

            if (resultadoContratos.Importados > 0)
            {
                mensajeExito = $"Importación completada: {resultadoContratos.Importados} contratos importados.";
            }
            else if (resultadoContratos.Errores > 0)
            {
                mensajeError = $"Errores encontrados. Revisa los detalles.";
            }
            else
            {
                // Mostrar salida completa para debug
                mensajeError = $"No se pudo parsear el resultado. SALIDA COMPLETA DEL SCRIPT:\n\n{salida}";
            }

            // Limpiar archivo temporal
            if (File.Exists(rutaTemporal))
                File.Delete(rutaTemporal);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error durante la importación: {ex.Message}";
        }
        finally
        {
            procesando = false;
            tipoImportacion = string.Empty;
        }
    }

    private ResultadoImportacion ParsearResultado(string salida)
    {
        var resultado = new ResultadoImportacion();
        var lineas = salida.Split('\n');
        var erroresLista = new List<string>();

        foreach (var linea in lineas)
        {
            if (linea.Contains("importados:", StringComparison.OrdinalIgnoreCase) || linea.Contains("Importados:", StringComparison.OrdinalIgnoreCase))
            {
                var partes = linea.Split(':');
                if (partes.Length > 1 && int.TryParse(partes[1].Trim(), out int importados))
                {
                    resultado.Importados = importados;
                }
            }
            else if (linea.Contains("errores:", StringComparison.OrdinalIgnoreCase) || linea.Contains("Errores:", StringComparison.OrdinalIgnoreCase))
            {
                var partes = linea.Split(':');
                if (partes.Length > 1 && int.TryParse(partes[1].Trim(), out int errores))
                {
                    resultado.Errores = errores;
                }
            }
            else if (linea.Contains("[ERROR]"))
            {
                erroresLista.Add(linea.Replace("[ERROR]", "").Trim());
            }
        }

        resultado.DetalleErrores = erroresLista;
        return resultado;
    }

    private class ResultadoImportacion
    {
        public int Importados { get; set; }
        public int Errores { get; set; }
        public List<string> DetalleErrores { get; set; } = new();
    }
}
