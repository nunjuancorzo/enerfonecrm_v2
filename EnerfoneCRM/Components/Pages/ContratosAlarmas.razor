@page "/contratos/alarmas"
@using EnerfoneCRM.Models
@using EnerfoneCRM.Services
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms
@rendermode InteractiveServer
@inject ContratoService ContratoService
@inject TarifaAlarmaService TarifaAlarmaService
@inject EmpresaAlarmaService EmpresaAlarmaService
@inject ClienteService ClienteService
@inject FicheroClienteService FicheroClienteService
@inject FicheroContratoService FicheroContratoService
@inject ObservacionContratoService ObservacionContratoService
@inject AuthService AuthService
@inject UsuarioService UsuarioService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IJSRuntime JS

<PageTitle>Enerfone CRM - Contratos de Alarmas</PageTitle>

@if (cargandoSesion)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    @if (!AuthService.EstaAutenticado)
    {
        <div class="alert alert-warning m-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No tienes acceso a esta página. Por favor, inicia sesión.
        </div>
    }
    else if (AuthService.UsuarioActual?.Rol == "Comercializadora")
    {
        <div class="alert alert-warning m-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No tienes acceso a esta página. Los usuarios con rol Comercializadora solo pueden acceder a Contratos de Energía.
        </div>
    }
    else
    {
        <div class="container-fluid p-4" style="max-width: 2000px;">
            <div class="row mb-4">
                <div class="col-md-12">
                    <h2 class="mb-0">
                        <i class="bi bi-shield-check me-2 text-danger"></i>
                        Contratos de Alarmas
                    </h2>
                    <p class="text-muted">Gestión de contratos de sistemas de seguridad</p>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(mensajeExito))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>@mensajeExito
                    <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
                </div>
            }

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtros</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Estado</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="dropdownEstadoAla" data-bs-toggle="dropdown" aria-expanded="false">
                                    @if (estadosSeleccionados.Count == 0)
                                    {
                                        <span>Todos</span>
                                    }
                                    else if (estadosSeleccionados.Count == 1)
                                    {
                                        <span>@estadosSeleccionados.First()</span>
                                    }
                                    else
                                    {
                                        <span>@estadosSeleccionados.Count seleccionados</span>
                                    }
                                </button>
                                <ul class="dropdown-menu p-2 bg-white" aria-labelledby="dropdownEstadoAla" style="max-height: 300px; overflow-y: auto; width: 100%;" @onclick:stopPropagation="true">
                                    <li class="px-2 py-1">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="estadoTodosAla" @onchange="SeleccionarTodosEstados" checked="@(estadosSeleccionados.Count == 0)">
                                            <label class="form-check-label w-100" for="estadoTodosAla" style="cursor: pointer;">
                                                <small><strong>Todos</strong></small>
                                            </label>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider my-1"></li>
                                    @foreach (var estado in estadosDisponibles)
                                    {
                                        var estadoId = $"estadoAla_{estado.Replace(" ", "_")}";
                                        <li class="px-2 py-1">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="@estadoId" 
                                                       checked="@estadosSeleccionados.Contains(estado)"
                                                       @onchange="() => ToggleEstado(estado)">
                                                <label class="form-check-label w-100" for="@estadoId" style="cursor: pointer;">
                                                    <small>@estado</small>
                                                </label>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Tipo Inmueble</label>
                            <select @bind="filtroTipoInmueble" class="form-select">
                                <option value="">Todos</option>
                                <option value="Hogar">Hogar</option>
                                <option value="Negocio">Negocio</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Fecha Desde</label>
                            <input type="date" @bind="filtroFechaDesde" class="form-control" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Fecha Hasta</label>
                            <input type="date" @bind="filtroFechaHasta" class="form-control" />
                        </div>
                        <div class="col-md-2 d-flex align-items-end gap-2">
                            <button class="btn btn-primary w-100" @onclick="AplicarFiltros">
                                <i class="bi bi-search me-1"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Listado de Contratos</h5>
                    <div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" disabled="@(!contratosFiltrados.Any())">
                                <i class="bi bi-download me-2"></i>Exportar
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" @onclick="ExportarCSV" style="cursor: pointer;"><i class="bi bi-filetype-csv me-2"></i>Exportar a CSV</a></li>
                                <li><a class="dropdown-item" @onclick="ExportarExcel" style="cursor: pointer;"><i class="bi bi-file-earmark-excel me-2"></i>Exportar a Excel (XLSX)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (cargando)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando contratos...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando contratos...</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr style="font-size: 0.875rem;">
                                        <th style="cursor: pointer; width: 85px;" @onclick='() => OrdenarPor("FechaCreacion")'>
                                            F. Creación
                                            @if (columnaOrden == "FechaCreacion")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="cursor: pointer; width: 85px;" @onclick='() => OrdenarPor("FechaModificacion")'>
                                            F. Modificación
                                            @if (columnaOrden == "FechaModificacion")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="cursor: pointer; width: 100px;" @onclick='() => OrdenarPor("Estado")'>
                                            Estado
                                            @if (columnaOrden == "Estado")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="cursor: pointer; width: 200px;" @onclick='() => OrdenarPor("NombreCliente")'>
                                            Cliente
                                            @if (columnaOrden == "NombreCliente")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="cursor: pointer; width: 95px;" @onclick='() => OrdenarPor("Dni")'>
                                            DNI/CIF
                                            @if (columnaOrden == "Dni")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="width: 140px;">Empresa</th>
                                        <th style="cursor: pointer; width: 95px;" @onclick='() => OrdenarPor("TipoAlarma")'>
                                            Tipo Alarma
                                            @if (columnaOrden == "TipoAlarma")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="cursor: pointer; width: 110px;" @onclick='() => OrdenarPor("KitAlarma")'>
                                            Kit/Campaña
                                            @if (columnaOrden == "KitAlarma")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="width: 85px; cursor: pointer;" @onclick='() => OrdenarPor("Comercial")'>
                                            Comercial
                                            @if (columnaOrden == "Comercial")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th style="cursor: pointer; width: 80px;" @onclick='() => OrdenarPor("Comision")'>
                                            Comisión
                                            @if (columnaOrden == "Comision")
                                            {
                                                <i class="bi bi-@(ordenAscendente ? "arrow-up" : "arrow-down")"></i>
                                            }
                                        </th>
                                        <th class="text-end" style="width: 85px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (!contratos.Any())
                                    {
                                        <tr>
                                            <td colspan="11" class="text-center text-muted py-5">
                                                <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                                <p class="mb-0 mt-2">No hay contratos registrados</p>
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var contrato in contratosFiltrados)
                                        {
                                            <tr style="font-size: 0.875rem;">
                                                <td><small>@contrato.FechaCreacion?.ToString("dd/MM/yy")</small></td>
                                                <td><small class="text-muted">@contrato.FechaModificacion?.ToString("dd/MM/yy")</small></td>
                                                <td>
                                                    <span class="badge bg-info" style="font-size: 0.75rem;">@contrato.Estado</span>
                                                    @if (conteoObservacionesPorContrato.ContainsKey(contrato.Id) && conteoObservacionesPorContrato[contrato.Id] > 0)
                                                    {
                                                        <i class="bi bi-chat-left-text-fill text-primary ms-1" 
                                                           style="cursor: pointer; font-size: 0.85rem;" 
                                                           @onclick="() => MostrarHistoricoObservaciones(contrato.Id)"
                                                           title="Ver histórico de observaciones (@conteoObservacionesPorContrato[contrato.Id])"></i>
                                                    }
                                                </td>
                                                <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><small><strong>@contrato.NombreCliente</strong></small></td>
                                                <td style="max-width: 95px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><small>@(contrato.Dni ?? contrato.Cliente?.DniCif ?? "-")</small></td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(contrato.EmpresaAlarma))
                                                    {
                                                        var empresa = empresasAlarmas.FirstOrDefault(e => e.Nombre == contrato.EmpresaAlarma);
                                                        if (empresa?.LogoContenido != null && empresa.LogoContenido.Length > 0)
                                                        {
                                                            var base64 = Convert.ToBase64String(empresa.LogoContenido);
                                                            var mimeType = ObtenerMimeType(empresa.LogoArchivo);
                                                            <img src="data:@mimeType;base64,@base64" alt="@empresa.Nombre" 
                                                                 style="max-width: 120px; max-height: 40px; object-fit: contain;" />
                                                        }
                                                        else
                                                        {
                                                            <small>@contrato.EmpresaAlarma</small>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted">-</small>
                                                    }
                                                </td>
                                                <td><span class="badge bg-secondary" style="font-size: 0.75rem;">@contrato.TipoAlarma</span></td>
                                                <td><small>@contrato.KitAlarma @contrato.CampanaAlarma</small></td>
                                                <td><small>@contrato.Comercial</small></td>
                                                <td><span class="badge bg-danger" style="font-size: 0.75rem;">@contrato.Comision?.ToString("N0")€</span></td>
                                                <td class="text-end" style="white-space: nowrap;">
                                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => MostrarModalEditar(contrato)" title="Editar">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmarEliminar(contrato)" title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        @* Paginación *@
                        <div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3">
                            <div>
                                <small class="text-muted">
                                    Mostrando @((paginaActual - 1) * elementosPorPagina + 1) - @(Math.Min(paginaActual * elementosPorPagina, totalElementos)) de @totalElementos contratos
                                </small>
                            </div>
                            @if (totalPaginas > 1)
                            {
                                <nav>
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => CambiarPagina(1)" disabled="@(paginaActual == 1)">
                                                <i class="bi bi-chevron-double-left"></i>
                                            </button>
                                        </li>
                                        <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => CambiarPagina(paginaActual - 1)" disabled="@(paginaActual == 1)">
                                                <i class="bi bi-chevron-left"></i>
                                            </button>
                                        </li>
                                        @for (int i = Math.Max(1, paginaActual - 2); i <= Math.Min(totalPaginas, paginaActual + 2); i++)
                                        {
                                            var pagina = i;
                                            <li class="page-item @(paginaActual == pagina ? "active" : "")">
                                                <button class="page-link" @onclick="() => CambiarPagina(pagina)">@pagina</button>
                                            </li>
                                        }
                                        <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => CambiarPagina(paginaActual + 1)" disabled="@(paginaActual == totalPaginas)">
                                                <i class="bi bi-chevron-right"></i>
                                            </button>
                                        </li>
                                        <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => CambiarPagina(totalPaginas)" disabled="@(paginaActual == totalPaginas)">
                                                <i class="bi bi-chevron-double-right"></i>
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Modal Editar -->
        @if (mostrarModal && contratoSeleccionado != null)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-height: 90vh;">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-pencil-square me-2"></i>
                                Editar Contrato de Alarma - ID: @contratoSeleccionado.Id
                            </h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal" disabled="@guardando"></button>
                        </div>
                        <EditForm Model="contratoSeleccionado" OnValidSubmit="GuardarContrato">
                            <DataAnnotationsValidator />
                            <div class="modal-header bg-light border-bottom">
                                <div class="d-flex gap-2 w-100">
                                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal" disabled="@guardando">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-danger" disabled="@guardando">
                                        @if (guardando)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-save me-2"></i>
                                        }
                                        Guardar
                                    </button>
                                </div>
                            </div>
                            <div class="modal-body" style="background-color: #e9ecef; max-height: calc(90vh - 140px); overflow-y: auto;">
                                @if (!string.IsNullOrEmpty(mensajeError))
                                {
                                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                        <i class="bi bi-exclamation-triangle me-2"></i>@mensajeError
                                        <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
                                    </div>
                                }
                                
                                <!-- Fechas -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-muted"><i class="bi bi-calendar-plus me-1"></i>Fecha de Creación</label>
                                        <input type="text" class="form-control" value="@contratoSeleccionado.FechaCreacion?.ToString("dd/MM/yyyy HH:mm")" readonly />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-muted"><i class="bi bi-calendar-check me-1"></i>Fecha de Modificación</label>
                                        <input type="text" class="form-control" value="@contratoSeleccionado.FechaModificacion?.ToString("dd/MM/yyyy HH:mm")" readonly />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-calendar-event me-1"></i>Fecha Alta</label>
                                        @if (AuthService.UsuarioActual?.Rol == "Administrador")
                                        {
                                            <input type="date" class="form-control" @bind="contratoSeleccionado.FechaAlta" />
                                        }
                                        else
                                        {
                                            <input type="text" class="form-control" value="@contratoSeleccionado.FechaAlta?.ToString("dd/MM/yyyy")" readonly />
                                        }
                                    </div>
                                </div>

                                <hr class="my-3" />

                                <!-- Información Básica -->
                                <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-info-circle me-2"></i>Información Básica</h6>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Cliente</label>
                                        <InputSelect class="form-select" @bind-Value="contratoSeleccionado.IdCliente">
                                            <option value="">-- Seleccionar Cliente --</option>
                                            @foreach (var cliente in clientes)
                                            {
                                                <option value="@cliente.Id">@cliente.Nombre (@cliente.DniCif)</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Estado</label>
                                        <InputSelect class="form-select" @bind-Value="contratoSeleccionado.Estado">
                                            <option value="">-- Seleccionar Estado --</option>
                                            @foreach (var estado in estadosDisponibles)
                                            {
                                                <option value="@estado">@estado</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Comercial</label>
                                        @if (AuthService.UsuarioActual?.Rol == "Administrador")
                                        {
                                            <select @bind="contratoSeleccionado.Comercial" class="form-select">
                                                <option value="">-- Seleccionar Comercial --</option>
                                                @foreach (var usuario in usuarios.OrderBy(u => u.NombreUsuario))
                                                {
                                                    <option value="@usuario.NombreUsuario">@usuario.NombreUsuario</option>
                                                }
                                            </select>
                                        }
                                        else
                                        {
                                            <InputText class="form-control" @bind-Value="contratoSeleccionado.Comercial" readonly />
                                        }
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">DNI</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.Dni" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">IBAN Cliente</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.Iban" />
                                    </div>
                                </div>
                                
                                @* Titular IBAN Diferente *@
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="chkTitularIbanDiferenteEdicionAlarma" @bind="contratoSeleccionado.TitularIbanDiferente">
                                            <label class="form-check-label fw-bold" for="chkTitularIbanDiferenteEdicionAlarma">
                                                Titular IBAN Diferente
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                @if (contratoSeleccionado.TitularIbanDiferente)
                                {
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">DNI Titular IBAN <span class="text-danger">*</span></label>
                                            <InputText @bind-Value="contratoSeleccionado.TitularIbanDni" class="form-control" placeholder="DNI/NIE" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Nombre Titular IBAN <span class="text-danger">*</span></label>
                                            <InputText @bind-Value="contratoSeleccionado.TitularIbanNombre" class="form-control" placeholder="Nombre completo" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Número IBAN <span class="text-danger">*</span></label>
                                            <InputText @bind-Value="contratoSeleccionado.TitularIbanNumero" class="form-control" placeholder="ES00 0000 0000 0000 0000 0000" />
                                        </div>
                                    </div>
                                }

                                <!-- Tipo de Alarma -->
                                <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-shield-check me-2"></i>Tipo de Alarma</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Empresa de Alarma <span class="text-danger">*</span></label>
                                        <InputSelect class="form-select" @bind-Value="contratoSeleccionado.EmpresaAlarma" @bind-Value:after="FiltrarTarifasPorEmpresa">
                                            <option value="">-- Seleccionar empresa --</option>
                                            @foreach (var empresa in empresasAlarmas)
                                            {
                                                <option value="@empresa.Nombre">@empresa.Nombre</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Tipo de Inmueble</label>
                                        <InputSelect class="form-select" @bind-Value="contratoSeleccionado.TipoAlarma">
                                            <option value="">-- Seleccionar --</option>
                                            <option value="Hogar">Hogar</option>
                                            <option value="Negocio">Negocio</option>
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Subtipo</label>
                                        @if (contratoSeleccionado.TipoAlarma == "Hogar")
                                        {
                                            <InputSelect class="form-select" @bind-Value="contratoSeleccionado.SubtipoInmueble">
                                                <option value="">-- Seleccionar --</option>
                                                <option value="Piso">Piso</option>
                                                <option value="Bajo">Bajo</option>
                                                <option value="Atico">Ático</option>
                                                <option value="Adosado">Adosado</option>
                                                <option value="Chalet">Chalet</option>
                                            </InputSelect>
                                        }
                                        else if (contratoSeleccionado.TipoAlarma == "Negocio")
                                        {
                                            <InputSelect class="form-select" @bind-Value="contratoSeleccionado.SubtipoInmueble">
                                                <option value="">-- Seleccionar --</option>
                                                <option value="Comercio">Comercio</option>
                                                <option value="Bar">Bar</option>
                                                <option value="Restaurante">Restaurante</option>
                                                <option value="Taller">Taller</option>
                                                <option value="Estanco">Estanco</option>
                                                <option value="Farmacia">Farmacia</option>
                                                <option value="Clinica">Clínica</option>
                                                <option value="Despacho">Despacho</option>
                                                <option value="Inmobiliaria">Inmobiliaria</option>
                                                <option value="Constructora">Constructora</option>
                                                <option value="Banco">Banco</option>
                                                <option value="Gasolinera">Gasolinera</option>
                                                <option value="Galeria de Arte">Galería de Arte</option>
                                                <option value="Loterias">Loterías</option>
                                                <option value="Salon de Juegos">Salón de Juegos</option>
                                                <option value="Joyeria">Joyería</option>
                                                <option value="Seguridad">Seguridad</option>
                                                <option value="Armero">Armero</option>
                                                <option value="Centro Universitario">Centro Universitario</option>
                                                <option value="Interiorismo y Decoracion">Interiorismo y Decoración</option>
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            <InputText class="form-control" @bind-Value="contratoSeleccionado.SubtipoInmueble" placeholder="Seleccione primero el tipo" disabled />
                                        }
                                    </div>
                                </div>

                                <!-- Contrato Anterior -->
                                <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-clock-history me-2"></i>Contrato Anterior</h6>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="form-check mt-4">
                                            <input type="checkbox" class="form-check-input" id="tieneContratoAnterior" 
                                                   checked="@(contratoSeleccionado.TieneContratoAnterior ?? false)"
                                                   @onchange="@((e) => contratoSeleccionado.TieneContratoAnterior = (bool?)((bool)e.Value!))" />
                                            <label class="form-check-label" for="tieneContratoAnterior">
                                                ¿Tiene contrato anterior?
                                            </label>
                                        </div>
                                    </div>
                                    @if (contratoSeleccionado.TieneContratoAnterior == true)
                                    {
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Compañía Anterior</label>
                                            <InputText class="form-control" @bind-Value="contratoSeleccionado.CompaniaAnterior" placeholder="Nombre de la compañía" />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Nº Contrato Anterior</label>
                                            <InputText class="form-control" @bind-Value="contratoSeleccionado.NumeroContratoAnterior" placeholder="Número de contrato" />
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label fw-bold">Fecha Permanencia</label>
                                            <InputDate Type="InputDateType.Date" class="form-control" @bind-Value="contratoSeleccionado.FechaPermanenciaAnterior" />
                                        </div>
                                    }
                                </div>

                                <!-- Qué Contratamos -->
                                <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-cart-check me-2"></i>Qué Contratamos</h6>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Kit</label>
                                        <InputSelect class="form-select" @bind-Value="contratoSeleccionado.KitAlarma">
                                            <option value="">-- Seleccionar Kit --</option>
                                            @foreach (var tarifa in tarifasKit)
                                            {
                                                <option value="@tarifa.NombreTarifa">@tarifa.NombreTarifa - @tarifa.CuotaMensual.ToString("N2")€</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Opcionales</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.OpcionalesAlarma" placeholder="Ej: Cámara adicional, Detector de humo" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Campaña</label>
                                        <InputSelect class="form-select" @bind-Value="contratoSeleccionado.CampanaAlarma">
                                            <option value="">-- Sin Campaña --</option>
                                            @foreach (var tarifa in tarifasCampana)
                                            {
                                                <option value="@tarifa.NombreTarifa">@tarifa.NombreTarifa - @tarifa.CuotaMensual.ToString("N2")€</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>

                                <!-- Instalación y Observaciones -->
                                <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="bi bi-geo-alt me-2"></i>Dirección de Instalación</h6>
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">Dirección</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.DireccionInstalacionAlarma" placeholder="Nombre de la calle" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Número</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.NumeroInstalacion" placeholder="Nº" />
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Escalera <small class="text-muted">(opcional)</small></label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.EscaleraInstalacion" placeholder="Esc." />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Piso <small class="text-muted">(opcional)</small></label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.PisoInstalacion" placeholder="Piso" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Puerta <small class="text-muted">(opcional)</small></label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.PuertaInstalacion" placeholder="Puerta" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Código Postal</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.CodigoPostalInstalacion" placeholder="CP" />
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Aclarador <small class="text-muted">(opcional)</small></label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.AclaradorInstalacion" placeholder="Información adicional de la dirección" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Localidad</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.LocalidadInstalacion" placeholder="Localidad" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Provincia</label>
                                        <InputText class="form-control" @bind-Value="contratoSeleccionado.ProvinciaInstalacion" placeholder="Provincia" />
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    @if (contratoSeleccionado.Id > 0)
                                    {
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Comisión (€)</label>
                                            <InputNumber class="form-control" @bind-Value="contratoSeleccionado.Comision" step="0.01" />
                                        </div>
                                    }
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Observaciones</label>
                                        <InputTextArea class="form-control" @bind-Value="contratoSeleccionado.ObservacionesAlarma" rows="3" />
                                    </div>
                                </div>

                                <!-- Facturas del Contrato -->
                                <hr />
                                <h6 class="mb-3"><i class="bi bi-receipt me-2"></i>Facturas del Contrato</h6>
                                <div class="row mb-3">
                                    <div class="col-12">
                                        @if (facturasContrato.Any())
                                        {
                                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                                <div class="list-group">
                                                    @foreach (var factura in facturasContrato)
                                                    {
                                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="bi bi-receipt text-success me-2"></i>
                                                                <span>@factura.NombreFichero</span>
                                                            </div>
                                                            <div>
                                                                <button type="button" class="btn btn-sm btn-outline-primary me-1" @onclick="async () => await DescargarFactura(factura.Id)" @onclick:preventDefault="true" @onclick:stopPropagation="true" title="Descargar">
                                                                    <i class="bi bi-download"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="async () => await EliminarFactura(factura.Id)" @onclick:preventDefault="true" @onclick:stopPropagation="true" title="Eliminar">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-muted fst-italic">No hay facturas adjuntas</p>
                                        }
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Adjuntar Factura</label>
                                        <InputFile OnChange="CargarFactura" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                                        <small class="text-muted">Formatos permitidos: PDF, JPG, PNG, DOC, DOCX (máx. 10MB)</small>
                                    </div>
                                </div>

                                <hr />

                                <!-- Histórico de Observaciones -->
                                <h6 class="mb-3">
                                    <i class="bi bi-clock-history me-2"></i>Histórico de Observaciones
                                    @if (PuedeEditar())
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="MostrarModalNuevaObservacion">
                                            <i class="bi bi-plus-circle me-1"></i>Agregar Observación
                                        </button>
                                    }
                                </h6>
                                <div class="row mb-3">
                                    <div class="col-12">
                                        @if (observacionesHistoricas.Any())
                                        {
                                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                                @foreach (var obs in observacionesHistoricas)
                                                {
                                                    <div class="card mb-2">
                                                        <div class="card-body p-2">
                                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                                <div>
                                                                    <small class="text-muted">
                                                                        <i class="bi bi-person-circle me-1"></i>
                                                                        <strong>@obs.Usuario</strong>
                                                                    </small>
                                                                    @if (!string.IsNullOrEmpty(obs.EstadoContrato))
                                                                    {
                                                                        <span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">@obs.EstadoContrato</span>
                                                                    }
                                                                </div>
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <small class="text-muted">
                                                                        <i class="bi bi-clock me-1"></i>
                                                                        @obs.FechaHora.ToString("dd/MM/yyyy HH:mm")
                                                                    </small>
                                                                    @if (PuedeEditar() && AuthService.UsuarioActual?.NombreUsuario == obs.Usuario)
                                                                    {
                                                                        <button type="button" class="btn btn-sm btn-outline-danger p-0 px-1" @onclick="() => EliminarObservacion(obs.Id)" title="Eliminar">
                                                                            <i class="bi bi-trash" style="font-size: 0.8rem;"></i>
                                                                        </button>
                                                                    }
                                                                </div>
                                                            </div>
                                                            <p class="mb-0" style="white-space: pre-wrap; font-size: 0.9rem;">@obs.Observacion</p>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-muted fst-italic">No hay observaciones registradas</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }

        <!-- Modal Confirmar Eliminación -->
        @if (mostrarModalEliminar)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Eliminación
                            </h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModalEliminar = false"></button>
                        </div>
                        <div class="modal-body p-4">
                            <p class="mb-3">¿Estás seguro de que deseas eliminar este contrato?</p>
                            <div class="alert alert-warning mb-0">
                                <strong>@contratoAEliminar?.NombreCliente</strong>
                                <p class="mb-0 mt-2">
                                    <small>@contratoAEliminar?.TipoAlarma - @contratoAEliminar?.Estado</small>
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="() => mostrarModalEliminar = false">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </button>
                            <button type="button" class="btn btn-danger" @onclick="EliminarContrato" disabled="@guardando">
                                @if (guardando)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Eliminando...</span>
                                }
                                else
                                {
                                    <i class="bi bi-trash me-2"></i>
                                    <span>Eliminar</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Modal para mostrar observaciones históricas *@
        @if (mostrarModalObservaciones)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-chat-left-text me-2"></i>Histórico de Observaciones
                            </h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalObservaciones"></button>
                        </div>
                        <div class="modal-body">
                            @if (observacionesHistoricasModal.Any())
                            {
                                <div class="list-group">
                                    @foreach (var obs in observacionesHistoricasModal)
                                    {
                                        <div class="list-group-item">
                                            <small class="text-muted">
                                                <i class="bi bi-person me-1"></i>@obs.Usuario
                                                <i class="bi bi-calendar ms-2 me-1"></i>@obs.FechaHora.ToString("dd/MM/yyyy HH:mm")
                                                @if (!string.IsNullOrEmpty(obs.EstadoContrato))
                                                {
                                                    <span class="badge bg-secondary ms-2">@obs.EstadoContrato</span>
                                                }
                                            </small>
                                            <p class="mb-0 mt-2">@obs.Observacion</p>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted mb-0"><i class="bi bi-info-circle me-1"></i>No hay observaciones registradas para este contrato</p>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModalObservaciones">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Modal para nueva observación *@
        @if (mostrarModalNuevaObservacion)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-plus-circle me-2"></i>Nueva Observación
                            </h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModalNuevaObservacion = false"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Observación</label>
                                <textarea @bind="nuevaObservacionTexto" class="form-control" rows="4" placeholder="Ingrese la observación..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" @onclick="() => mostrarModalNuevaObservacion = false">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" @onclick="GuardarNuevaObservacion" 
                                    disabled="@(string.IsNullOrWhiteSpace(nuevaObservacionTexto) || guardandoObservacion)">
                                @if (guardandoObservacion)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
}

@code {
    private List<Contrato> contratos = new();
    private List<Contrato> contratosFiltrados = new();
    private List<Contrato> contratosParaPaginar = new();
    private List<Cliente> clientes = new();
    private List<Usuario> usuarios = new();
    private List<TarifaAlarma> tarifasKit = new();
    private List<TarifaAlarma> tarifasCampana = new();
    private List<EmpresaAlarma> empresasAlarmas = new();
    private List<FicheroContrato> facturasContrato = new();
    
    // Facturas temporales para contratos nuevos (antes de tener ID)
    private List<(string nombreArchivo, byte[] contenido)> facturasPendientes = new();
    
    private Contrato? contratoSeleccionado;
    private Contrato? contratoAEliminar;
    
    private bool cargandoSesion = true;
    private bool cargando = false;
    private bool guardando = false;
    private bool mostrarModal = false;
    private bool mostrarModalEliminar = false;
    private bool mostrarModalObservaciones = false;
    private bool mostrarModalNuevaObservacion = false;
    private string observacionesActuales = string.Empty;
    private string nuevaObservacionTexto = string.Empty;
    private bool guardandoObservacion = false;
    private List<ObservacionContrato> observacionesHistoricas = new();
    private List<ObservacionContrato> observacionesHistoricasModal = new();
    private Dictionary<int, int> conteoObservacionesPorContrato = new();
    
    private string mensajeExito = string.Empty;
    private string mensajeError = string.Empty;
    
    // Filtros
    private HashSet<string> estadosSeleccionados = new();
    private List<string> estadosDisponibles = new() { "Pte Carga", "Pte Firma", "En incidencia", "Pte Documentación", "Pte Validación", "En Curso", "En Activación", "En tramitación", "Activo", "Act/Facturable", "En Liquidación", "Liquidado", "Baja", "Cancelado", "Scoring" };
    private string filtroTipoInmueble = string.Empty;
    private DateTime? filtroFechaDesde;
    private DateTime? filtroFechaHasta;

    // Ordenamiento
    private string columnaOrden = "FechaCreacion";
    private bool ordenAscendente = false;

    // Paginación
    private int paginaActual = 1;
    private int elementosPorPagina = 10;
    private int totalElementos = 0;
    private int totalPaginas = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthService.CargarSesionAsync();
            cargandoSesion = false;
            
            if (AuthService.EstaAutenticado)
            {
                await CargarDatos();
                StateHasChanged();
            }
            else
            {
                StateHasChanged();
            }
        }
    }

    private async Task CargarDatos()
    {
        cargando = true;
        StateHasChanged();
        
        try
        {
            var rol = AuthService.UsuarioActual?.Rol;
            var usuario = AuthService.UsuarioActual?.NombreUsuario;
            var usuarioId = AuthService.UsuarioActual?.Id;
            
            contratos = await ContratoService.ObtenerTodosPorTipoAsync("alarma", rol, usuario, usuarioId);
            clientes = await ClienteService.ObtenerTodosAsync();
            usuarios = await UsuarioService.ObtenerTodosAsync();
            empresasAlarmas = await EmpresaAlarmaService.ObtenerActivasAsync();
            tarifasKit = await TarifaAlarmaService.ObtenerPorTipoAsync("Kit");
            tarifasCampana = await TarifaAlarmaService.ObtenerPorTipoAsync("Campaña");
            
            await CargarConteoObservaciones();
            AplicarFiltros();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }
    
    private async Task FiltrarTarifasPorEmpresa()
    {
        try
        {
            if (string.IsNullOrEmpty(contratoSeleccionado?.EmpresaAlarma))
            {
                tarifasKit = await TarifaAlarmaService.ObtenerPorTipoAsync("Kit");
                tarifasCampana = await TarifaAlarmaService.ObtenerPorTipoAsync("Campaña");
                return;
            }

            var todasTarifas = await TarifaAlarmaService.ObtenerTodasAsync();
            var tarifasFiltradas = todasTarifas.Where(t => t.Empresa == contratoSeleccionado.EmpresaAlarma).ToList();
            
            tarifasKit = tarifasFiltradas.Where(t => t.Tipo == "Kit").ToList();
            tarifasCampana = tarifasFiltradas.Where(t => t.Tipo == "Campaña").ToList();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al filtrar tarifas: {ex.Message}";
            tarifasKit = new();
            tarifasCampana = new();
        }
    }
    
    private void AplicarFiltros()
    {
        var listaTemp = contratos.ToList();

        if (estadosSeleccionados.Count > 0)
        {
            listaTemp = listaTemp.Where(c => estadosSeleccionados.Contains(c.Estado)).ToList();
        }

        if (!string.IsNullOrEmpty(filtroTipoInmueble))
        {
            listaTemp = listaTemp.Where(c => 
                c.SubtipoInmueble != null && 
                c.SubtipoInmueble.Contains(filtroTipoInmueble, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }

        if (filtroFechaDesde.HasValue)
        {
            listaTemp = listaTemp.Where(c => 
                c.FechaCreacion.HasValue && 
                c.FechaCreacion.Value.Date >= filtroFechaDesde.Value.Date
            ).ToList();
        }

        if (filtroFechaHasta.HasValue)
        {
            listaTemp = listaTemp.Where(c => 
                c.FechaCreacion.HasValue && 
                c.FechaCreacion.Value.Date <= filtroFechaHasta.Value.Date
            ).ToList();
        }

        // Guardar en contratosParaPaginar en lugar de contratosFiltrados
        contratosParaPaginar = listaTemp;

        // Aplicar ordenamiento y paginación
        AplicarOrdenamiento();
    }

    private void OrdenarPor(string columna)
    {
        if (columnaOrden == columna)
        {
            ordenAscendente = !ordenAscendente;
        }
        else
        {
            columnaOrden = columna;
            ordenAscendente = true;
        }

        paginaActual = 1; // Resetear a la primera página al ordenar
        AplicarOrdenamiento();
    }

    private void AplicarOrdenamiento()
    {
        // Ordenar la lista filtrada completa
        var listaOrdenada = columnaOrden switch
        {
            "FechaCreacion" => ordenAscendente 
                ? contratosParaPaginar.OrderBy(c => c.FechaCreacion).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.FechaCreacion).ToList(),
            "FechaModificacion" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.FechaModificacion).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.FechaModificacion).ToList(),
            "Estado" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.Estado).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.Estado).ToList(),
            "NombreCliente" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.NombreCliente).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.NombreCliente).ToList(),
            "Dni" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.Dni ?? c.Cliente?.DniCif).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.Dni ?? c.Cliente?.DniCif).ToList(),
            "TipoAlarma" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.TipoAlarma).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.TipoAlarma).ToList(),
            "KitAlarma" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.KitAlarma).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.KitAlarma).ToList(),
            "Comercial" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.Comercial).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.Comercial).ToList(),
            "Comision" => ordenAscendente
                ? contratosParaPaginar.OrderBy(c => c.Comision).ToList()
                : contratosParaPaginar.OrderByDescending(c => c.Comision).ToList(),
            _ => contratosParaPaginar.ToList()
        };

        // Actualizar la lista para paginar con la lista ordenada
        contratosParaPaginar = listaOrdenada;

        // Calcular paginación
        totalElementos = contratosParaPaginar.Count;
        totalPaginas = totalElementos > 0 ? (int)Math.Ceiling(totalElementos / (double)elementosPorPagina) : 0;
        
        // Asegurar que la página actual esté dentro del rango
        if (totalPaginas == 0)
            paginaActual = 1;
        else if (paginaActual > totalPaginas)
            paginaActual = totalPaginas;
        else if (paginaActual < 1)
            paginaActual = 1;

        // Aplicar paginación a contratosFiltrados que es lo que se muestra
        contratosFiltrados = contratosParaPaginar
            .Skip((paginaActual - 1) * elementosPorPagina)
            .Take(elementosPorPagina)
            .ToList();
    }

    private void ToggleEstado(string estado)
    {
        if (estadosSeleccionados.Contains(estado))
        {
            estadosSeleccionados.Remove(estado);
        }
        else
        {
            estadosSeleccionados.Add(estado);
        }
    }

    private void SeleccionarTodosEstados(ChangeEventArgs e)
    {
        if (e.Value is bool seleccionado && seleccionado)
        {
            estadosSeleccionados.Clear();
        }
    }

    private void CambiarPagina(int nuevaPagina)
    {
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas)
        {
            paginaActual = nuevaPagina;
            AplicarOrdenamiento();
            StateHasChanged();
        }
    }
    
    private void ExportarCSV()
    {
        try
        {
            var csv = new System.Text.StringBuilder();
            
            // Encabezados
            csv.AppendLine("ID,Fecha Creación,Estado,Comercial,Cliente,DNI,Dirección,Tipo Alarma,Subtipo Inmueble,Kit,Opcionales,Campaña,Dirección Instalación,Comisión,Observaciones");
            
            // Datos - usar contratosParaPaginar que contiene todos los filtrados (sin paginación)
            foreach (var contrato in contratosParaPaginar)
            {
                csv.AppendLine($"\"{contrato.Id}\"," +
                    $"\"{contrato.FechaCreacion?.ToString("dd/MM/yyyy")}\"," +
                    $"\"{contrato.Estado}\"," +
                    $"\"{contrato.Comercial}\"," +
                    $"\"{contrato.NombreCliente}\"," +
                    $"\"{contrato.Dni}\"," +
                    $"\"{contrato.Direccion}\"," +
                    $"\"{contrato.TipoAlarma}\"," +
                    $"\"{contrato.SubtipoInmueble}\"," +
                    $"\"{contrato.KitAlarma}\"," +
                    $"\"{contrato.OpcionalesAlarma}\"," +
                    $"\"{contrato.CampanaAlarma}\"," +
                    $"\"{contrato.DireccionInstalacionAlarma}\"," +
                    $"\"{contrato.Comision?.ToString("N2")}\"," +
                    $"\"{contrato.ObservacionesAlarma}\"");
            }

            // Crear archivo para descargar
            var bytes = System.Text.Encoding.UTF8.GetPreamble().Concat(System.Text.Encoding.UTF8.GetBytes(csv.ToString())).ToArray();
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"contratos_alarmas_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            // Descargar usando JavaScript
            JS.InvokeVoidAsync("eval", $@"
                const link = document.createElement('a');
                link.href = 'data:text/csv;charset=utf-8;base64,{base64}';
                link.download = '{fileName}';
                link.click();
            ");
            
            mensajeExito = $"Exportados {contratosParaPaginar.Count} contratos a CSV";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al exportar: {ex.Message}";
        }
    }

    private void ExportarExcel()
    {
        try
        {
            using var workbook = new ClosedXML.Excel.XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Contratos Alarmas");

            // Encabezados
            worksheet.Cell(1, 1).Value = "ID";
            worksheet.Cell(1, 2).Value = "Fecha Creación";
            worksheet.Cell(1, 3).Value = "Estado";
            worksheet.Cell(1, 4).Value = "Comercial";
            worksheet.Cell(1, 5).Value = "Cliente";
            worksheet.Cell(1, 6).Value = "DNI";
            worksheet.Cell(1, 7).Value = "Dirección";
            worksheet.Cell(1, 8).Value = "Tipo Alarma";
            worksheet.Cell(1, 9).Value = "Subtipo Inmueble";
            worksheet.Cell(1, 10).Value = "Kit";
            worksheet.Cell(1, 11).Value = "Opcionales";
            worksheet.Cell(1, 12).Value = "Campaña";
            worksheet.Cell(1, 13).Value = "Dirección Instalación";
            worksheet.Cell(1, 14).Value = "Comisión";
            worksheet.Cell(1, 15).Value = "Observaciones";

            // Estilo de encabezados
            var headerRange = worksheet.Range(1, 1, 1, 15);
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.LightGray;
            headerRange.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;

            // Datos
            int row = 2;
            foreach (var contrato in contratosParaPaginar)
            {
                worksheet.Cell(row, 1).Value = contrato.Id;
                worksheet.Cell(row, 2).Value = contrato.FechaCreacion?.ToString("dd/MM/yyyy") ?? "";
                worksheet.Cell(row, 3).Value = contrato.Estado ?? "";
                worksheet.Cell(row, 4).Value = contrato.Comercial ?? "";
                worksheet.Cell(row, 5).Value = contrato.NombreCliente ?? "";
                worksheet.Cell(row, 6).Value = contrato.Dni ?? "";
                worksheet.Cell(row, 7).Value = contrato.Direccion ?? "";
                worksheet.Cell(row, 8).Value = contrato.TipoAlarma ?? "";
                worksheet.Cell(row, 9).Value = contrato.SubtipoInmueble ?? "";
                worksheet.Cell(row, 10).Value = contrato.KitAlarma ?? "";
                worksheet.Cell(row, 11).Value = contrato.OpcionalesAlarma ?? "";
                worksheet.Cell(row, 12).Value = contrato.CampanaAlarma ?? "";
                worksheet.Cell(row, 13).Value = contrato.DireccionInstalacionAlarma ?? "";
                worksheet.Cell(row, 14).Value = contrato.Comision?.ToString("N2") ?? "";
                worksheet.Cell(row, 15).Value = contrato.ObservacionesAlarma ?? "";
                row++;
            }

            // Ajustar ancho de columnas
            worksheet.Columns().AdjustToContents();

            // Guardar en memoria y descargar
            using var stream = new System.IO.MemoryStream();
            workbook.SaveAs(stream);
            var bytes = stream.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"contratos_alarmas_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // Descargar usando JavaScript
            JS.InvokeVoidAsync("eval", $@"
                const link = document.createElement('a');
                link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{base64}';
                link.download = '{fileName}';
                link.click();
            ");

            mensajeExito = $"Exportados {contratosParaPaginar.Count} contratos a Excel (XLSX)";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al exportar: {ex.Message}";
        }
    }

    private async Task MostrarModalEditar(Contrato contrato)
    {
        contratoSeleccionado = new Contrato
        {
            Id = contrato.Id,
            Tipo = "alarma",
            Estado = contrato.Estado,
            Comercial = contrato.Comercial,
            IdCliente = contrato.IdCliente,
            NombreCliente = contrato.NombreCliente,
            Dni = contrato.Dni,
            Direccion = contrato.Direccion,
            Iban = contrato.Iban,
            Comision = contrato.Comision,
            TitularIbanDiferente = contrato.TitularIbanDiferente,
            TitularIbanDni = contrato.TitularIbanDni,
            TitularIbanNombre = contrato.TitularIbanNombre,
            TitularIbanNumero = contrato.TitularIbanNumero,
            TipoAlarma = contrato.TipoAlarma,
            SubtipoInmueble = contrato.SubtipoInmueble,
            TieneContratoAnterior = contrato.TieneContratoAnterior,
            CompaniaAnterior = contrato.CompaniaAnterior,
            NumeroContratoAnterior = contrato.NumeroContratoAnterior,
            FechaPermanenciaAnterior = contrato.FechaPermanenciaAnterior,
            EmpresaAlarma = contrato.EmpresaAlarma,
            KitAlarma = contrato.KitAlarma,
            OpcionalesAlarma = contrato.OpcionalesAlarma,
            CampanaAlarma = contrato.CampanaAlarma,
            DireccionInstalacionAlarma = contrato.DireccionInstalacionAlarma,
            NumeroInstalacion = contrato.NumeroInstalacion,
            EscaleraInstalacion = contrato.EscaleraInstalacion,
            PisoInstalacion = contrato.PisoInstalacion,
            PuertaInstalacion = contrato.PuertaInstalacion,
            CodigoPostalInstalacion = contrato.CodigoPostalInstalacion,
            ProvinciaInstalacion = contrato.ProvinciaInstalacion,
            LocalidadInstalacion = contrato.LocalidadInstalacion,
            AclaradorInstalacion = contrato.AclaradorInstalacion,
            ObservacionesAlarma = contrato.ObservacionesAlarma,
            FechaCreacion = contrato.FechaCreacion,
            FechaModificacion = contrato.FechaModificacion,
            FechaAlta = contrato.FechaAlta ?? contrato.FechaCreacion
        };
        
        // Cargar y filtrar tarifas por empresa
        await FiltrarTarifasPorEmpresa();
        
        // Cargar facturas del contrato
        await CargarFacturasContrato();
        
        // Cargar observaciones históricas
        await CargarObservacionesHistoricas();
        
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        contratoSeleccionado = null;
    }

    private async Task GuardarContrato()
    {
        // Validar campos obligatorios para contratos de alarmas
        if (string.IsNullOrWhiteSpace(contratoSeleccionado.DireccionInstalacionAlarma))
        {
            mensajeError = "La dirección de instalación es obligatoria";
            guardando = false;
            return;
        }

        // Validar campos de titular IBAN si está marcado
        if (contratoSeleccionado.TitularIbanDiferente)
        {
            if (string.IsNullOrWhiteSpace(contratoSeleccionado.TitularIbanDni))
            {
                mensajeError = "El DNI del titular IBAN es obligatorio";
                guardando = false;
                return;
            }
            if (string.IsNullOrWhiteSpace(contratoSeleccionado.TitularIbanNombre))
            {
                mensajeError = "El nombre del titular IBAN es obligatorio";
                guardando = false;
                return;
            }
            if (string.IsNullOrWhiteSpace(contratoSeleccionado.TitularIbanNumero))
            {
                mensajeError = "El número IBAN es obligatorio";
                guardando = false;
                return;
            }
        }

        guardando = true;
        StateHasChanged();
        
        try
        {
            // Obtener datos del cliente seleccionado
            if (contratoSeleccionado.IdCliente.HasValue)
            {
                var cliente = clientes.FirstOrDefault(c => c.Id == contratoSeleccionado.IdCliente.Value);
                if (cliente != null)
                {
                    contratoSeleccionado.NombreCliente = cliente.Nombre;
                    contratoSeleccionado.Dni = cliente.DniCif;
                    contratoSeleccionado.Direccion = cliente.Direccion;
                }
            }

            bool exito = contratoSeleccionado.Id > 0
                ? await ContratoService.ActualizarAsync(contratoSeleccionado)
                : await ContratoService.CrearAsync(contratoSeleccionado);

            if (exito)
            {
                mensajeExito = contratoSeleccionado.Id > 0 ? "Contrato actualizado exitosamente" : "Contrato creado exitosamente";
                CerrarModal();
                await CargarDatos();
            }
            else
            {
                mensajeError = "Error al guardar el contrato";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private void ConfirmarEliminar(Contrato contrato)
    {
        contratoAEliminar = contrato;
        mostrarModalEliminar = true;
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
    }

    private async Task EliminarContrato()
    {
        if (contratoAEliminar == null) return;

        guardando = true;
        StateHasChanged();

        try
        {
            bool exito = await ContratoService.EliminarAsync(contratoAEliminar.Id);
            
            if (exito)
            {
                mensajeExito = "Contrato eliminado exitosamente";
                mostrarModalEliminar = false;
                await CargarDatos();
            }
            else
            {
                mensajeError = "Error al eliminar el contrato";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private async Task CargarFacturasContrato()
    {
        if (contratoSeleccionado == null) return;

        try
        {
            facturasContrato = await FicheroContratoService.ObtenerFacturasContratoAsync(contratoSeleccionado.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar facturas: {ex.Message}";
        }
    }

    private async Task CargarFactura(InputFileChangeEventArgs e)
    {
        if (contratoSeleccionado == null) return;

        try
        {
            var archivo = e.File;
            if (archivo.Size > 10 * 1024 * 1024)
            {
                mensajeError = "El archivo no debe superar los 10MB";
                return;
            }

            using var ms = new MemoryStream();
            await archivo.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(ms);
            var contenido = ms.ToArray();

            var resultado = await FicheroContratoService.GuardarFacturaAsync(
                contratoSeleccionado.Id,
                archivo.Name,
                contenido
            );

            if (resultado.exito)
            {
                mensajeExito = resultado.mensaje;
                CargarFacturasContrato();
            }
            else
            {
                mensajeError = resultado.mensaje;
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar el archivo: {ex.Message}";
        }
    }

    private async Task DescargarFactura(int facturaId)
    {
        try
        {
            var factura = await FicheroContratoService.DescargarFacturaAsync(facturaId);
            if (factura != null && factura.Fichero != null)
            {
                var base64 = Convert.ToBase64String(factura.Fichero);
                var mimeType = ObtenerMimeType(factura.NombreFichero ?? "archivo");
                await JS.InvokeVoidAsync("downloadFile", factura.NombreFichero, $"data:{mimeType};base64,{base64}");
            }
            else
            {
                mensajeError = "No se pudo descargar el archivo";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al descargar: {ex.Message}";
        }
    }

    private async Task EliminarFactura(int facturaId)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "¿Estás seguro de que deseas eliminar esta factura?"))
            return;

        try
        {
            var resultado = await FicheroContratoService.EliminarFacturaAsync(facturaId);
            if (resultado.exito)
            {
                mensajeExito = resultado.mensaje;
                CargarFacturasContrato();
            }
            else
            {
                mensajeError = resultado.mensaje;
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al eliminar: {ex.Message}";
        }
    }

    private string ObtenerMimeType(string nombreArchivo)
    {
        var extension = Path.GetExtension(nombreArchivo).ToLower();
        return extension switch
        {
            ".pdf" => "application/pdf",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".png" => "image/png",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            _ => "application/octet-stream"
        };
    }

    // Métodos para observaciones históricas
    private async Task CargarObservacionesHistoricas()
    {
        if (contratoSeleccionado == null || contratoSeleccionado.Id == 0) return;
        
        try
        {
            observacionesHistoricas = await ObservacionContratoService.ObtenerPorContratoAsync(contratoSeleccionado.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar observaciones: {ex.Message}";
        }
    }

    private async Task MostrarHistoricoObservaciones(int contratoId)
    {
        try
        {
            observacionesHistoricasModal = await ObservacionContratoService.ObtenerPorContratoAsync(contratoId);
            mostrarModalObservaciones = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar observaciones: {ex.Message}";
        }
    }

    private void MostrarModalNuevaObservacion()
    {
        nuevaObservacionTexto = string.Empty;
        mostrarModalNuevaObservacion = true;
    }

    private async Task GuardarNuevaObservacion()
    {
        if (string.IsNullOrWhiteSpace(nuevaObservacionTexto) || contratoSeleccionado == null || contratoSeleccionado.Id == 0)
            return;

        guardandoObservacion = true;
        try
        {
            var nuevaObservacion = new ObservacionContrato
            {
                IdContrato = contratoSeleccionado.Id,
                Observacion = nuevaObservacionTexto.Trim(),
                Usuario = AuthService.UsuarioActual?.NombreUsuario ?? "Sistema",
                FechaHora = DateTime.Now,
                EstadoContrato = contratoSeleccionado.Estado
            };

            await ObservacionContratoService.CrearAsync(nuevaObservacion);
            await CargarObservacionesHistoricas();
            await CargarConteoObservaciones();
            
            nuevaObservacionTexto = string.Empty;
            mostrarModalNuevaObservacion = false;
            mensajeExito = "Observación añadida correctamente";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al guardar observación: {ex.Message}";
        }
        finally
        {
            guardandoObservacion = false;
            StateHasChanged();
        }
    }

    private async Task EliminarObservacion(int observacionId)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "¿Estás seguro de que deseas eliminar esta observación?"))
            return;

        try
        {
            await ObservacionContratoService.EliminarAsync(observacionId);
            await CargarObservacionesHistoricas();
            await CargarConteoObservaciones();
            mensajeExito = "Observación eliminada correctamente";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al eliminar observación: {ex.Message}";
        }
    }

    private void MostrarObservaciones(string observaciones)
    {
        observacionesActuales = observaciones;
        mostrarModalObservaciones = true;
    }

    private void CerrarModalObservaciones()
    {
        mostrarModalObservaciones = false;
        observacionesActuales = string.Empty;
        observacionesHistoricasModal.Clear();
    }

    private async Task CargarConteoObservaciones()
    {
        try
        {
            conteoObservacionesPorContrato.Clear();
            
            foreach (var contrato in contratos)
            {
                var observaciones = await ObservacionContratoService.ObtenerPorContratoAsync(contrato.Id);
                conteoObservacionesPorContrato[contrato.Id] = observaciones.Count;
            }
        }
        catch (Exception ex)
        {
            // Error silencioso para no interrumpir la carga de contratos
            Console.WriteLine($"Error al cargar conteo de observaciones: {ex.Message}");
        }
    }

    private bool PuedeEditar()
    {
        return AuthService.EsAdministrador || AuthService.EsComercializadora;
    }

    private string ObtenerColorEstado(string estado)
    {
        return estado?.ToLower() switch
        {
            "pte carga" => "bg-secondary",
            "pte firma" => "bg-primary",
            "en incidencia" => "bg-warning text-dark",
            "pte documentación" => "bg-purple text-white",
            "pte validación" => "bg-info",
            "en activación" => "bg-cyan text-white",
            "en tramitación" => "bg-teal-light text-dark",
            "en liquidación" => "bg-light text-dark",
            "en curso" => "bg-orange text-white",
            "activo" => "bg-success",
            "act/facturable" => "bg-teal text-white",
            "liquidado" => "bg-indigo text-white",
            "baja" => "bg-dark",
            "cancelado" => "bg-secondary text-white",
            "scoring" => "bg-danger text-white",
            _ => "bg-muted"
        };
    }
}
