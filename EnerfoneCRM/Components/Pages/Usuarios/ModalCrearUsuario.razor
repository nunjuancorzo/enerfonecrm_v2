@using EnerfoneCRM.Models
@using System.ComponentModel.DataAnnotations
@inject EnerfoneCRM.Services.TarifaEnergiaService TarifaEnergiaService
@inject EnerfoneCRM.Services.UsuarioService UsuarioService
@inject EnerfoneCRM.Services.ComercializadoraService ComercializadoraService

<div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Usuario</h5>
                <button type="button" class="btn-close" @onclick="OnCancelar"></button>
            </div>
            <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre de Usuario</label>
                        <InputText class="form-control" @bind-Value="model.NombreUsuario" />
                        <ValidationMessage For="@(() => model.NombreUsuario)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="model.Email" type="email" />
                        <ValidationMessage For="@(() => model.Email)" />
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <InputText class="form-control" @bind-Value="model.Nombre" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellidos</label>
                            <InputText class="form-control" @bind-Value="model.Apellidos" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <InputText class="form-control" @bind-Value="model.Direccion" />
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Código Postal</label>
                            <InputText class="form-control" @bind-Value="model.CodigoPostal" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Localidad</label>
                            <InputText class="form-control" @bind-Value="model.Localidad" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Contraseña</label>
                            <InputText class="form-control" @bind-Value="model.Password" type="password" />
                            <ValidationMessage For="@(() => model.Password)" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirmar Contraseña</label>
                            <InputText class="form-control" @bind-Value="model.ConfirmarPassword" type="password" />
                            <ValidationMessage For="@(() => model.ConfirmarPassword)" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <InputSelect class="form-select" @bind-Value="model.Rol" @bind-Value:after="OnRolChanged">
                            <option value="">Seleccionar rol...</option>
                            <option value="Usuario">Usuario</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Gestor">Gestor</option>
                            <option value="Comercializadora">Comercializadora</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => model.Rol)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comercializadora @(model.Rol == "Comercializadora" ? "*" : "(opcional)")</label>
                        <InputSelect class="form-select" @bind-Value="model.Comercializadora">
                            <option value="">Seleccionar comercializadora...</option>
                            @foreach (var comercializadora in comercializadoras)
                            {
                                <option value="@comercializadora">@comercializadora</option>
                            }
                        </InputSelect>
                        @if (model.Rol == "Comercializadora" && string.IsNullOrEmpty(model.Comercializadora))
                        {
                            <div class="text-danger small mt-1">La comercializadora es obligatoria para este rol</div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comisión (%)</label>
                        <InputNumber class="form-control" @bind-Value="model.Comision" />
                    </div>

                    <div class="mb-3">
                        <hr />
                        <h6 class="mb-3"><i class="bi bi-building me-2"></i>Comercializadoras Permitidas</h6>
                        <p class="text-muted small">Selecciona las comercializadoras que este usuario podrá visualizar. Si no seleccionas ninguna, podrá ver todas.</p>
                        
                        <div class="row">
                            @foreach (var comercializadora in todasComercializadoras)
                            {
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" 
                                               class="form-check-input" 
                                               id="com_@comercializadora.Id" 
                                               checked="@comercializadorasSeleccionadas.Contains(comercializadora.Id)"
                                               @onchange="@((e) => OnComercializadoraToggle(comercializadora.Id, (bool)e.Value!))" />
                                        <label class="form-check-label" for="com_@comercializadora.Id">
                                            @comercializadora.Nombre
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                        @if (!todasComercializadoras.Any())
                        {
                            <div class="alert alert-info">No hay comercializadoras registradas en el sistema.</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="OnCancelar">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Usuario</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<(Usuario usuario, string password, List<int> comercializadorasIds)> OnGuardar { get; set; }
    [Parameter] public EventCallback OnCancelar { get; set; }

    private CrearUsuarioModel model = new();
    private List<string> comercializadoras = new();
    private List<Comercializadora> todasComercializadoras = new();
    private HashSet<int> comercializadorasSeleccionadas = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarComercializadoras();
        await CargarTodasComercializadoras();
    }

    private async Task CargarComercializadoras()
    {
        try
        {
            comercializadoras = await TarifaEnergiaService.ObtenerEmpresasAsync();
        }
        catch
        {
            comercializadoras = new List<string>();
        }
    }

    private async Task CargarTodasComercializadoras()
    {
        try
        {
            todasComercializadoras = await ComercializadoraService.ObtenerTodasAsync();
        }
        catch
        {
            todasComercializadoras = new List<Comercializadora>();
        }
    }

    private void OnComercializadoraToggle(int comercializadoraId, bool isChecked)
    {
        if (isChecked)
        {
            comercializadorasSeleccionadas.Add(comercializadoraId);
        }
        else
        {
            comercializadorasSeleccionadas.Remove(comercializadoraId);
        }
    }

    private void OnRolChanged()
    {
        // Limpiar comercializadora si cambia el rol y no es Comercializadora
        if (model.Rol != "Comercializadora")
        {
            model.Comercializadora = null;
        }
    }

    private async Task HandleSubmit()
    {
        // Validar comercializadora obligatoria para rol Comercializadora
        if (model.Rol == "Comercializadora" && string.IsNullOrEmpty(model.Comercializadora))
        {
            return; // No enviar si falta comercializadora
        }

        var usuario = new Usuario
        {
            NombreUsuario = model.NombreUsuario,
            Email = model.Email,
            Nombre = model.Nombre,
            Apellidos = model.Apellidos,
            Direccion = model.Direccion,
            CodigoPostal = model.CodigoPostal,
            Localidad = model.Localidad,
            Rol = model.Rol,
            Comercializadora = model.Comercializadora,
            Comision = model.Comision,
            Activo = true
        };

        await OnGuardar.InvokeAsync((usuario, model.Password, comercializadorasSeleccionadas.ToList()));
    }

    private class CrearUsuarioModel
    {
        [Required(ErrorMessage = "El nombre de usuario es requerido")]
        [StringLength(45)]
        public string NombreUsuario { get; set; } = string.Empty;

        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        [StringLength(45)]
        public string Email { get; set; } = string.Empty;

        [StringLength(100)]
        public string? Nombre { get; set; }

        [StringLength(100)]
        public string? Apellidos { get; set; }

        [StringLength(255)]
        public string? Direccion { get; set; }

        [StringLength(10)]
        public string? CodigoPostal { get; set; }

        [StringLength(100)]
        public string? Localidad { get; set; }

        [Required(ErrorMessage = "La contraseña es requerida")]
        [StringLength(50, MinimumLength = 6, ErrorMessage = "La contraseña debe tener al menos 6 caracteres")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Debe confirmar la contraseña")]
        [Compare("Password", ErrorMessage = "Las contraseñas no coinciden")]
        public string ConfirmarPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "El rol es requerido")]
        public string Rol { get; set; } = string.Empty;

        [StringLength(255)]
        public string? Comercializadora { get; set; }

        public decimal Comision { get; set; } = 0.00m;
    }
}
